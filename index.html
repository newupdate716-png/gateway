<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸ’Ž Premium SMS Monitor</title>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- No other external files needed -->
</head>
<body>
    <!-- The dashboard will be rendered inside this div by JavaScript -->
    <div id="app"></div>

    <!-- Your complete JavaScript code goes here, inside script tags -->
    <script>
        // ==================== API.JS - SMS MONITOR (Vercel Edition) ====================
        // Author: SMS Monitor System
        // Version: 2.0 (Pure JavaScript, Serverless Ready)
        // Hosting: Vercel, Netlify, GitHub Pages (Fully Static + API)

        // Data storage using localStorage (or can be replaced with Vercel KV/PostgreSQL)
        // For production, you can integrate with: Vercel KV (Redis), Supabase, or MongoDB

        // Configuration
        const CONFIG = {
            APP_NAME: 'ðŸ’Ž Premium SMS Monitor',
            VERSION: '2.0',
            DB_KEY: 'sms_monitor_db',
            AUTO_REFRESH: 30000, // 30 seconds
            PENDING_STATUS: 'PENDING',
            COMPLETED_STATUS: 'COMPLETED'
        };

        // ==================== DATABASE LAYER (localStorage) ====================
        class Database {
            constructor() {
                this.initDatabase();
            }

            initDatabase() {
                if (!localStorage.getItem(CONFIG.DB_KEY)) {
                    const initialData = {
                        transactions: [],
                        backup_sms: [],
                        stats: {
                            total_transactions: 0,
                            today_transactions: 0,
                            total_amount: 0,
                            pending_transactions: 0,
                            completed_transactions: 0,
                            service_distribution: {}
                        }
                    };
                    localStorage.setItem(CONFIG.DB_KEY, JSON.stringify(initialData));
                }
            }

            getDB() {
                return JSON.parse(localStorage.getItem(CONFIG.DB_KEY));
            }

            saveDB(db) {
                localStorage.setItem(CONFIG.DB_KEY, JSON.stringify(db));
                this.updateStats(db);
            }

            updateStats(db) {
                const today = new Date().toDateString();
                let totalAmount = 0;
                let pendingCount = 0;
                let completedCount = 0;
                let todayCount = 0;
                let serviceDist = {};

                db.transactions.forEach(t => {
                    // Count by status
                    if (t.status === CONFIG.PENDING_STATUS) pendingCount++;
                    else if (t.status === CONFIG.COMPLETED_STATUS) completedCount++;

                    // Today's transactions
                    if (new Date(t.timestamp).toDateString() === today) {
                        todayCount++;
                    }

                    // Total amount (completed only)
                    if (t.status === CONFIG.COMPLETED_STATUS && t.amount) {
                        const amt = parseFloat(t.amount.toString().replace(/[^0-9.]/g, ''));
                        if (!isNaN(amt)) totalAmount += amt;
                    }

                    // Service distribution (completed only)
                    if (t.status === CONFIG.COMPLETED_STATUS && t.service_type) {
                        const service = t.service_type;
                        serviceDist[service] = (serviceDist[service] || 0) + 1;
                    }
                });

                db.stats = {
                    total_transactions: db.transactions.length,
                    today_transactions: todayCount,
                    total_amount: totalAmount.toFixed(2),
                    pending_transactions: pendingCount,
                    completed_transactions: completedCount,
                    service_distribution: serviceDist
                };

                localStorage.setItem(CONFIG.DB_KEY, JSON.stringify(db));
            }

            // ==================== TRANSACTION METHODS ====================
            saveTransaction(transactionData, ip = '0.0.0.0') {
                const db = this.getDB();

                // Check for duplicate transaction ID
                if (transactionData.transaction_id) {
                    const existing = db.transactions.find(t => 
                        t.transaction_id === transactionData.transaction_id
                    );
                    if (existing) {
                        return { 
                            success: true, 
                            message: 'Transaction already exists',
                            status: existing.status 
                        };
                    }
                }

                // Create new transaction
                const newTransaction = {
                    id: Date.now() + '-' + Math.random().toString(36).substr(2, 9),
                    sender: transactionData.sender || '',
                    amount: transactionData.amount || '',
                    transaction_id: transactionData.transaction_id || '',
                    account_number: transactionData.account_number || '',
                    reference: transactionData.reference || '',
                    service_type: transactionData.service_type || 'Other',
                    transaction_type: transactionData.transaction_type || 'Unknown',
                    timestamp: new Date().toISOString(),
                    sim_info: transactionData.sim_info || '',
                    original_message: transactionData.original_message || '',
                    ip_address: ip,
                    device_info: navigator.userAgent,
                    status: CONFIG.PENDING_STATUS,
                    verified_at: null,
                    verified_by: null
                };

                db.transactions.unshift(newTransaction); // Add to beginning
                this.saveDB(db);
                return { success: true, message: 'Transaction saved as PENDING' };
            }

            saveBackup(smsData, ip = '0.0.0.0') {
                const db = this.getDB();
                db.backup_sms.unshift({
                    id: Date.now() + '-' + Math.random().toString(36).substr(2, 9),
                    sms_data: smsData,
                    timestamp: new Date().toISOString(),
                    ip_address: ip
                });
                // Keep only last 100 backup SMS to prevent storage overflow
                if (db.backup_sms.length > 100) db.backup_sms.pop();
                this.saveDB(db);
                return { success: true };
            }

            getStatistics() {
                const db = this.getDB();
                
                // Format service distribution for display
                const serviceDistArray = Object.entries(db.stats.service_distribution)
                    .map(([service_type, count]) => ({ service_type, count }))
                    .sort((a, b) => b.count - a.count);

                // Get recent transactions (last 50)
                const recentTransactions = db.transactions.slice(0, 50);

                return {
                    total_transactions: db.stats.total_transactions,
                    today_transactions: db.stats.today_transactions,
                    total_amount: db.stats.total_amount,
                    service_distribution: serviceDistArray,
                    recent_transactions: recentTransactions,
                    pending_transactions: db.stats.pending_transactions,
                    completed_transactions: db.stats.completed_transactions
                };
            }

            // ==================== VERIFICATION METHODS ====================
            verifyPayment(service, amount, txid) {
                const db = this.getDB();
                const cleanAmount = parseFloat(amount.toString().replace(/[^0-9.]/g, '')).toString();

                // Find PENDING transaction
                const transaction = db.transactions.find(t => 
                    t.status === CONFIG.PENDING_STATUS &&
                    t.service_type?.toLowerCase() === service.toLowerCase() &&
                    t.transaction_id === txid &&
                    parseFloat(t.amount?.toString().replace(/[^0-9.]/g, '') || '0').toString() === cleanAmount
                );

                if (transaction) {
                    transaction.status = CONFIG.COMPLETED_STATUS;
                    transaction.verified_at = new Date().toISOString();
                    transaction.verified_by = 'API';
                    this.saveDB(db);
                    return {
                        success: true,
                        matched_records: 1,
                        message: 'Transaction verified and marked as COMPLETED',
                        status: CONFIG.COMPLETED_STATUS
                    };
                } else {
                    // Check if exists but not PENDING
                    const existing = db.transactions.find(t => 
                        t.service_type?.toLowerCase() === service.toLowerCase() &&
                        t.transaction_id === txid
                    );

                    if (existing) {
                        return {
                            success: false,
                            error: 'TRANSACTION_NOT_PENDING',
                            message: 'Transaction found but not in PENDING state',
                            status: existing.status
                        };
                    } else {
                        return {
                            success: false,
                            error: 'NO_MATCH',
                            message: 'No matching PENDING transaction found'
                        };
                    }
                }
            }

            verifyPaymentWithoutTxid(service, amount) {
                const db = this.getDB();
                const cleanAmount = parseFloat(amount.toString().replace(/[^0-9.]/g, '')).toString();

                // Find most recent PENDING transaction with matching service and amount
                const transaction = db.transactions.find(t => 
                    t.status === CONFIG.PENDING_STATUS &&
                    t.service_type?.toLowerCase() === service.toLowerCase() &&
                    parseFloat(t.amount?.toString().replace(/[^0-9.]/g, '') || '0').toString() === cleanAmount
                );

                if (transaction) {
                    transaction.status = CONFIG.COMPLETED_STATUS;
                    transaction.verified_at = new Date().toISOString();
                    transaction.verified_by = 'API';
                    this.saveDB(db);
                    return {
                        success: true,
                        matched_records: 1,
                        transaction_id: transaction.transaction_id,
                        message: 'Transaction verified and marked as COMPLETED',
                        status: CONFIG.COMPLETED_STATUS
                    };
                } else {
                    return {
                        success: false,
                        error: 'NO_MATCH',
                        message: 'No matching PENDING transaction found'
                    };
                }
            }

            checkTransactionStatus(txid) {
                const db = this.getDB();
                const transaction = db.transactions.find(t => t.transaction_id === txid);
                
                if (transaction) {
                    return {
                        success: true,
                        status: transaction.status,
                        verified_at: transaction.verified_at
                    };
                } else {
                    return {
                        success: false,
                        error: 'Transaction not found'
                    };
                }
            }

            clearDatabase() {
                localStorage.removeItem(CONFIG.DB_KEY);
                this.initDatabase();
                return { success: true, message: 'Database cleared successfully' };
            }
        }

        // Initialize database
        const db = new Database();

        // ==================== API ROUTES ====================
        // This function handles API requests based on URL parameters
        function handleAPIRequest() {
            const urlParams = new URLSearchParams(window.location.search);
            const action = urlParams.get('action');
            // We'll use a simple method detection: if there's an action and data is sent via POST, we'll treat as POST
            // For simplicity in this static version, we'll use GET for all API calls, but you can adapt.
            // In a real app, you'd use fetch POST.

            // Only handle if action parameter exists
            if (action) {
                let response = { success: false, error: 'Invalid action' };

                switch (action) {
                    case 'save_transaction':
                        const data = urlParams.get('data') || '{}';
                        try {
                            response = db.saveTransaction(JSON.parse(decodeURIComponent(data)), 'web');
                        } catch (e) {
                            response = { success: false, error: 'Invalid JSON data' };
                        }
                        break;

                    case 'save_backup':
                        const smsData = urlParams.get('sms_data') || '';
                        response = db.saveBackup(decodeURIComponent(smsData), 'web');
                        break;

                    case 'get_stats':
                        response = db.getStatistics();
                        break;

                    case 'verify_payment':
                        const service = urlParams.get('service') || '';
                        const amount = urlParams.get('amount') || '';
                        const txid = urlParams.get('txid') || '';
                        
                        if (!service || !amount || !txid) {
                            response = { success: false, error: 'Missing service, amount or transaction ID' };
                        } else {
                            response = db.verifyPayment(service, amount, txid);
                        }
                        break;

                    case 'verify_payment_without_txid':
                        const service2 = urlParams.get('service') || '';
                        const amount2 = urlParams.get('amount') || '';
                        
                        if (!service2 || !amount2) {
                            response = { success: false, error: 'Missing service or amount' };
                        } else {
                            response = db.verifyPaymentWithoutTxid(service2, amount2);
                        }
                        break;

                    case 'check_transaction_status':
                        const txid2 = urlParams.get('txid') || '';
                        if (!txid2) {
                            response = { success: false, error: 'Missing transaction ID' };
                        } else {
                            response = db.checkTransactionStatus(txid2);
                        }
                        break;

                    case 'clear_database':
                        response = db.clearDatabase();
                        break;
                }

                // If this is an API call (detected by parameter), output JSON and exit
                if (action) {
                    document.body.innerHTML = `<pre>${JSON.stringify(response, null, 2)}</pre>`;
                    return true; // Indicates API response was sent
                }
            }
            return false; // No API action
        }

        // ==================== UI RENDERING ====================
        function renderDashboard() {
            const stats = db.getStatistics();
            const app = document.getElementById('app');
            if (!app) return;

            app.innerHTML = `
                <div class="dashboard">
                    <!-- Header -->
                    <div class="header">
                        <div class="header-left">
                            <div class="logo">
                                <i class="fas fa-sms"></i>
                            </div>
                            <div class="title">
                                <h1>${CONFIG.APP_NAME}</h1>
                                <p>Real-time SMS Transaction Dashboard â€¢ Auto Pending System</p>
                            </div>
                        </div>
                        <div class="badge">
                            <i class="fas fa-shield-alt"></i> 100% Secure â€¢ Pending â†’ Completed
                        </div>
                    </div>

                    <!-- Stats Grid -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon blue">
                                <i class="fas fa-exchange-alt"></i>
                            </div>
                            <div class="stat-title">Total Transactions</div>
                            <div class="stat-value" id="totalTransactions">${stats.total_transactions}</div>
                            <div class="stat-subtitle">All time transactions</div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon yellow">
                                <i class="fas fa-hourglass-half"></i>
                            </div>
                            <div class="stat-title">Pending</div>
                            <div class="stat-value" id="pendingTransactions">${stats.pending_transactions}</div>
                            <div class="stat-subtitle">Awaiting verification</div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon green">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <div class="stat-title">Completed</div>
                            <div class="stat-value" id="completedTransactions">${stats.completed_transactions}</div>
                            <div class="stat-subtitle">Verified transactions</div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon orange">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <div class="stat-title">Today's</div>
                            <div class="stat-value" id="todayTransactions">${stats.today_transactions}</div>
                            <div class="stat-subtitle">Transactions today</div>
                        </div>
                    </div>
                    
                    <!-- Main Content -->
                    <div class="main-content">
                        <div class="section-title">
                            <i class="fas fa-list"></i> Recent Transactions
                        </div>
                        
                        <div class="action-bar">
                            <div class="search-container">
                                <i class="fas fa-search search-icon"></i>
                                <input type="text" class="search-input" placeholder="Search by number, ID, or amount..." id="searchInput">
                            </div>
                            
                            <div class="filter-buttons">
                                <button class="filter-btn active" onclick="window.filterTransactions('all')">
                                    <i class="fas fa-layer-group"></i> All
                                </button>
                                <button class="filter-btn" onclick="window.filterTransactions('pending')">
                                    <i class="fas fa-hourglass-half"></i> Pending
                                </button>
                                <button class="filter-btn" onclick="window.filterTransactions('completed')">
                                    <i class="fas fa-check-circle"></i> Completed
                                </button>
                            </div>
                        </div>
                        
                        <div class="transactions-table" id="transactionsTable">
                            ${renderTransactionsTable(stats.recent_transactions)}
                        </div>
                        
                        <!-- Service Distribution -->
                        ${renderServiceDistribution(stats.service_distribution)}
                    </div>
                    
                    <!-- Footer -->
                    <div class="footer">
                        <p>Â© ${new Date().getFullYear()} Premium SMS Monitor System â€¢ Auto Pending System â€¢ Version ${CONFIG.VERSION}</p>
                        <p style="margin-top: 10px; font-size: 12px; opacity: 0.7;">
                            <i class="fas fa-lock"></i> 100% Secure â€¢ Pending until verified â€¢ Once completed, cannot be verified again
                        </p>
                    </div>
                </div>
                
                <!-- Transaction Details Modal -->
                <div class="modal-overlay" id="transactionModal">
                    <div class="modal">
                        <div class="modal-header">
                            <div class="modal-title">
                                <i class="fas fa-receipt"></i> Transaction Details
                            </div>
                            <button class="close-btn" onclick="closeModal()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body" id="modalBody">
                            <!-- Dynamic content -->
                        </div>
                    </div>
                </div>
            `;

            attachEventListeners();
        }

        function renderTransactionsTable(transactions) {
            if (!transactions || transactions.length === 0) {
                return `
                    <div class="no-data">
                        <i class="fas fa-inbox"></i>
                        <h3>No transactions found</h3>
                        <p>Transactions will appear here when received via SMS</p>
                    </div>
                `;
            }

            return `
                <table>
                    <thead>
                        <tr>
                            <th>Status</th>
                            <th>Service</th>
                            <th>Transaction ID</th>
                            <th>Amount</th>
                            <th>Sender/Receiver</th>
                            <th>Account/Reference</th>
                            <th>Type</th>
                            <th>Time</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${transactions.map(t => renderTransactionRow(t)).join('')}
                    </tbody>
                </table>
            `;
        }

        function renderTransactionRow(transaction) {
            const service = (transaction.service_type || 'other').toLowerCase();
            const isReceived = (transaction.transaction_type || '').toLowerCase().includes('received');
            const status = (transaction.status || 'pending').toLowerCase();
            const rowClass = status === 'completed' ? 'status-completed-row' : 'status-pending-row';

            return `
                <tr class="${rowClass}" 
                    data-service="${service}" 
                    data-status="${status}"
                    data-transaction='${JSON.stringify(transaction).replace(/'/g, "&apos;")}'>
                    <td>
                        <span class="status-badge status-${status}">
                            <i class="fas fa-${status === 'completed' ? 'check-circle' : 'hourglass-half'}"></i>
                            ${status.toUpperCase()}
                        </span>
                    </td>
                    <td>
                        <span class="service-badge ${service}">
                            <i class="fas fa-${getServiceIcon(service)}"></i>
                            ${transaction.service_type || 'Other'}
                        </span>
                    </td>
                    <td>
                        <div class="transaction-id">
                            ${transaction.transaction_id || 'N/A'}
                        </div>
                    </td>
                    <td>
                        <div class="amount ${isReceived ? 'received' : 'sent'}">
                            à§³${transaction.amount || '0.00'}
                        </div>
                    </td>
                    <td>
                        <div class="sender-info">
                            <div class="sender-number">
                                ${transaction.sender || 'N/A'}
                            </div>
                            ${transaction.account_number ? `
                            <div class="sender-name">
                                ${transaction.account_number}
                            </div>
                            ` : ''}
                        </div>
                    </td>
                    <td>
                        <div class="balance">
                            ${transaction.reference || transaction.account_number || 'N/A'}
                        </div>
                    </td>
                    <td>
                        ${transaction.transaction_type || 'N/A'}
                    </td>
                    <td>
                        <div class="timestamp">
                            ${new Date(transaction.timestamp).toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })}
                        </div>
                    </td>
                    <td>
                        <button class="view-btn" onclick="viewTransaction('${transaction.id}')">
                            <i class="fas fa-eye"></i> View
                        </button>
                    </td>
                </tr>
            `;
        }

        function getServiceIcon(service) {
            const icons = {
                'bkash': 'mobile-alt',
                'nagad': 'wallet',
                'rocket': 'rocket',
                'bank': 'university'
            };
            return icons[service] || 'money-bill';
        }

        function renderServiceDistribution(distribution) {
            if (!distribution || distribution.length === 0) return '';

            return `
                <div class="section-title" style="margin-top: 40px;">
                    <i class="fas fa-chart-pie"></i> Completed Service Distribution
                </div>
                <div class="service-distribution">
                    ${distribution.map(service => {
                        const serviceName = service.service_type.toLowerCase();
                        const icon = getServiceIcon(serviceName);
                        const colors = {
                            'bkash': '#E2136E',
                            'nagad': '#F8A61C',
                            'rocket': '#4CAF50',
                            'bank': '#3B82F6'
                        };
                        const bgColor = colors[serviceName] || '#8B5CF6';

                        return `
                            <div class="service-item">
                                <div class="service-icon" style="background: ${bgColor};">
                                    <i class="fas fa-${icon}"></i>
                                </div>
                                <div>
                                    <div class="service-count">${service.count}</div>
                                    <div class="service-name">${service.service_type}</div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function attachEventListeners() {
            // Search functionality
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase();
                    const rows = document.querySelectorAll('#transactionsTable tbody tr');
                    
                    rows.forEach(row => {
                        const text = row.textContent.toLowerCase();
                        row.style.display = text.includes(searchTerm) ? '' : 'none';
                    });
                });
            }
        }

        // Global functions for UI interaction
        window.filterTransactions = function(filter) {
            const rows = document.querySelectorAll('#transactionsTable tbody tr');
            const buttons = document.querySelectorAll('.filter-btn');
            
            buttons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            rows.forEach(row => {
                if (filter === 'all') {
                    row.style.display = '';
                } else {
                    const status = row.getAttribute('data-status');
                    row.style.display = status === filter ? '' : 'none';
                }
            });
        };

        window.viewTransaction = function(transactionId) {
            const stats = db.getStatistics();
            const transaction = stats.recent_transactions.find(t => t.id === transactionId);
            if (!transaction) return;

            const modal = document.getElementById('transactionModal');
            const modalBody = document.getElementById('modalBody');
            
            const isReceived = (transaction.transaction_type || '').toLowerCase().includes('received');
            const service = transaction.service_type || 'Unknown';
            const status = transaction.status || 'PENDING';
            
            let detailsHTML = `
                <div class="detail-row">
                    <div class="detail-label">Status:</div>
                    <div class="detail-value">
                        <span class="status-badge status-${status.toLowerCase()}">
                            <i class="fas fa-${status.toLowerCase() === 'completed' ? 'check-circle' : 'hourglass-half'}"></i>
                            ${status}
                        </span>
                    </div>
                </div>
                
                <div class="detail-row">
                    <div class="detail-label">Service Provider:</div>
                    <div class="detail-value">
                        <span class="service-badge ${service.toLowerCase()}">
                            <i class="fas fa-${getServiceIcon(service.toLowerCase())}"></i>
                            ${service}
                        </span>
                    </div>
                </div>
                
                <div class="detail-row">
                    <div class="detail-label">Transaction ID:</div>
                    <div class="detail-value" style="font-family: monospace; font-weight: 700;">${transaction.transaction_id || 'N/A'}</div>
                </div>
                
                <div class="detail-row">
                    <div class="detail-label">Amount:</div>
                    <div class="detail-value" style="color: ${isReceived ? 'var(--secondary)' : 'var(--danger)'}; font-size: 20px; font-weight: 800;">
                        à§³${transaction.amount || '0.00'} 
                        <span style="font-size: 14px; color: var(--gray);">(${isReceived ? 'Received' : 'Sent/Payment'})</span>
                    </div>
                </div>
                
                <div class="detail-row">
                    <div class="detail-label">${isReceived ? 'Sender Number' : 'Receiver'}:</div>
                    <div class="detail-value">${transaction.sender || 'N/A'}</div>
                </div>
                
                <div class="detail-row">
                    <div class="detail-label">Account/Reference:</div>
                    <div class="detail-value">${transaction.account_number || transaction.reference || 'N/A'}</div>
                </div>
                
                <div class="detail-row">
                    <div class="detail-label">Transaction Type:</div>
                    <div class="detail-value">${transaction.transaction_type || 'N/A'}</div>
                </div>
                
                <div class="detail-row">
                    <div class="detail-label">Transaction Time:</div>
                    <div class="detail-value">${new Date(transaction.timestamp).toLocaleString()}</div>
                </div>`;
                
            if (transaction.verified_at) {
                detailsHTML += `
                <div class="detail-row">
                    <div class="detail-label">Verified At:</div>
                    <div class="detail-value">${new Date(transaction.verified_at).toLocaleString()}</div>
                </div>`;
            }
            
            if (transaction.verified_by) {
                detailsHTML += `
                <div class="detail-row">
                    <div class="detail-label">Verified By:</div>
                    <div class="detail-value">${transaction.verified_by}</div>
                </div>`;
            }
            
            detailsHTML += `
                <div class="detail-row">
                    <div class="detail-label">SIM Information:</div>
                    <div class="detail-value">${transaction.sim_info || 'Not Available'}</div>
                </div>
                
                <div class="sms-preview">
                    <div class="sms-title">
                        <i class="fas fa-sms"></i> Original SMS Message
                    </div>
                    <div class="sms-content">${transaction.original_message || 'No original message available'}</div>
                </div>
            `;
            
            modalBody.innerHTML = detailsHTML;
            modal.style.display = 'flex';
        };

        window.closeModal = function() {
            document.getElementById('transactionModal').style.display = 'none';
        };

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('transactionModal');
            if (event.target === modal) {
                closeModal();
            }
        };

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', () => {
            // Check if this is an API call first
            if (handleAPIRequest()) {
                // If it was an API call, handleAPIRequest already output JSON and we stop further execution
                return;
            }

            // Otherwise, render the dashboard
            renderDashboard();

            // Auto refresh every 30 seconds
            setInterval(() => {
                const stats = db.getStatistics();
                document.getElementById('totalTransactions').textContent = stats.total_transactions;
                document.getElementById('pendingTransactions').textContent = stats.pending_transactions;
                document.getElementById('completedTransactions').textContent = stats.completed_transactions;
                document.getElementById('todayTransactions').textContent = stats.today_transactions;
                
                // Refresh transactions table if needed
                const transactionsTable = document.getElementById('transactionsTable');
                if (transactionsTable) {
                    const tbody = transactionsTable.querySelector('tbody');
                    if (tbody) {
                        // Simple refresh - you can enhance this
                        location.reload();
                    }
                }
            }, 30000);
        });

        // Export for use in Android app
        window.SMSMonitor = {
            saveTransaction: (data) => db.saveTransaction(data),
            saveBackup: (smsData) => db.saveBackup(smsData),
            getStats: () => db.getStatistics()
        };
    </script>

    <!-- Styles are included in the script tag above, but we can also put them here for clarity.
         The style is appended to head via JavaScript, so no need to duplicate. -->
    <style>
        /* Your existing styles from the JavaScript code are appended by the script.
           To ensure styles load even if script fails, we can include them here as well,
           but it's optional. For simplicity, we rely on the script to add them.
           The script creates a <style> tag and appends it to head. */
    </style>
</body>
</html> 
